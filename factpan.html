<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FACTORY</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/style.css">
  <title>FACTORY</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
  <script type="text/javascript" src="js/spawn.js"></script>
  <style>
    #panorama {
      width: 100vw;
      height: 100vh;
    }
  </style>

</head>
<body background="img/menu_background.jpg">


  <div  class="overlay" id="startOverlay">
        <button id="startButton" class="center" onclick="startGame()">START</button>
  </div>

  <div id="player" style="display: none;">
    <button id="guesser" onclick="showMapOverlay()">Guess</button>
    <button id="panRead" class="timeRead"></button>
    <div id="panorama"></div>
  </div>


  creating map component with the map image using the leaflet CRS Simple library
  <div id="leaflet_container">

    <div id="map"></div>
  
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
       integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
       crossorigin="">
    </script>
  
    <script>
      function init() {

        let map = L.map('map', {
          crs: L.CRS.Simple
        });
        let imageURL = 'locations\\FACT\\overlay\\FACT_Base.jpg';
        let imageBnds = [[0,0],[432,768]];
  
        L.imageOverlay(imageURL,imageBnds).addTo(map);
        //map.fitBounds(imageBnds);
        map.setView([216,384],0);
        
        //creating buffer zones to restrict map dragging by user
        let bnds = map.getBounds();
        let pdgRatio = 0.2;
        let pddBnds = bnds.pad(pdgRatio);
        map.fitBounds(pddBnds);
        map.setMaxBounds(pddBnds);
        

        map.on('click', guess);
      }
  
    </script>

  </div>
  
  
  <div class="overlay" id="scoreOverlay" >
    <div id="scoreReader" class="center">0</div>


    <!-- Second leaflet container for the score screen -->
    <div id="score_map"></div>
  
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
       integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
       crossorigin="">
    </script>
  
    <script>
      function scoreMap() {

        const spawn_data = JSON.parse(sessionStorage.getItem('spawn_data'));
        const spawn_name = sessionStorage.getItem('spawn_name');
        const user_coords = JSON.parse(sessionStorage.getItem('user_click'));

        console.log(user_coords);

        let imageURL = getScoreMap(spawn_name,spawn_data);

        let score_map = L.map('score_map', {
          crs: L.CRS.Simple
        });
        let imageBnds = [[0,0],[432,768]];
  
        L.imageOverlay(imageURL,imageBnds).addTo(score_map);
        score_map.setView(user_coords,1);

        //creating buffer zones to restrict map dragging by user
        let bnds = score_map.getBounds();
        let pdg_ratio = 0.1;
        let pdd_bnds = bnds.pad(pdg_ratio);
        score_map.fitBounds(pdd_bnds);
        score_map.setView(user_coords,1);

        const corr_coords = getSpawnXY(spawn_data);

        const marker_layer = L.layerGroup().addTo(score_map);
        const line_layer = L.layerGroup().addTo(score_map);

        
        const mark_line = L.polyline([corr_coords, user_coords], { color: "green", weight: 3 }).addTo(score_map);

        const corr_mark = L.marker(corr_coords).addTo(marker_layer);
        const user_mark = L.marker(user_coords).addTo(marker_layer);

        score_map.setView(corr_coords,1);


        // line_layer.bringToFront();
        // marker_layer.bringToFront();

        if(corr_coords.lng<user_coords.lng){
          score_map.setView(corr_coords,1);
        }else{
          score_map.setView(user_coords,1);
        }
        
        score_map.invalidateSize();

      }
      
    </script>



    <div class="banner">
      <button id="homeButton" onclick="window.location.href='index.html';">HOME</button>
      <button id="finishButton" onclick="window.location.href='map_sel.html';">FINISH</button>
      <button id="leaderButton" onclick="window.location.href='404.html';">LEADERBOARD</button>
    </div>
  </div>

</body>
</html>
